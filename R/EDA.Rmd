---
title: "Breast Exploratory Analysis"
author: "Jonathan Ma"
date: "`r Sys.Date()`"
output:
  word_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(stringr)
library(ggthemes)
library(scales)
```

Project Idea: Bayesian Hierarchal Model > Posterior Summary > Clustering. 

Data: Breast Cancer Data from SEER. 

Level via Tumor, Patient, and Region (Urban/Rural Code). 

We start with 5149008 observations of 12 variables (V#). 

*Level 1: Tumor*

V3: SEER stage (Localized, Regional, Distant). == STAGE

V7: Tumor Grade (Grade 1-4 or unknown). == GRADE

V10: EOD Tumor Size (1988+) == SIZE

*Level 2: Patient*

V1: Patient ID. == ID

V4: Binned Age group at diagnosis. == AGE

V5: Patient Sex. == SEX

V6: Race/Ethnicity. == RACETH

V11: Year of Diagnosis. == YEAR

V12: Marital Status. == MARRY

*Level 3: Region*

V2: Regional Area (Metro < 250k, Metro < 1m, Metro > 1m, Nonmetro adjacent, nonmetro nonadjacent, unknown). == REGION


```{r Data Loading}
seer <- read.delim("../data/raw/breastcancer.txt", sep = "\t", header = FALSE, stringsAsFactors = FALSE)
```

```{r Rename and NA drop}
seer_prime <- seer %>%
  transmute(
    ID     = V1,
    REGION = V2,
    STAGE  = V3,
    AGE    = V4,
    SEX    = V5,
    RACETH = V6,
    GRADE  = V7,
    SIZE   = V10,
    YEAR   = V11,
    MARRY  = V12
  )

seer_prime <- seer_prime %>%
  mutate(across(where(is.character), ~na_if(., "Unknown"))) %>%
  mutate(across(where(is.character), ~na_if(., "Blank(s)")))

seer_prime <- seer_prime %>%
  filter(complete.cases(.))

total_cases <- nrow(seer)
complete_cases <- nrow(seer_prime)
percent_complete <- round(100 * complete_cases / total_cases, 2)

cat("Complete cases:", complete_cases, "out of", total_cases,
    sprintf("(%s%% complete)\n", percent_complete))
```

we have 209123 cases to work with (4.06% of the whole thing) after removing "Unknown" and "Blank(s)" Values.

Further cleaning is done via tabling all variables.

REGION: collapse and recode into ordered, interpretable regional factors, removes the Alaska/Hawaii “unknown” entries.

```{r REGION}
seer_prime <- seer_prime %>%
  mutate(
    REGION = case_when(
      str_detect(REGION, "1 million") ~ "Large",
      str_detect(REGION, "lt 250") | str_detect(REGION, "250,000") ~ "Small",
      str_detect(REGION, "adjacent") | str_detect(REGION, "not adjacent") ~ "Nonmetro",
      TRUE ~ NA_character_
    ),
    REGION = factor(REGION, levels = c("Large", "Small", "Nonmetro"))
  )
table(seer_prime$REGION)
```

STAGE: restrict to tumors that are invasive (drop In situ, Unknown/unstaged).

```{r STAGE}
seer_prime <- seer_prime %>%
  mutate(
    STAGE = case_when(
      STAGE %in% c("Localized", "Regional", "Distant") ~ STAGE,
      TRUE ~ NA_character_
    ),
    STAGE = factor(STAGE, levels = c("Localized", "Regional", "Distant"))
  )
table(seer_prime$STAGE)
```

GRADE: extract numeric grade 1–4; drop cell‑line entries (“B‑cell”, “T‑cell” etc.).

```{r GRADE}
seer_prime <- seer_prime %>%
  mutate(
    GRADE = case_when(
      str_detect(GRADE, "I$") ~ "1",
      str_detect(GRADE, "II$") ~ "2",
      str_detect(GRADE, "III$") ~ "3",
      str_detect(GRADE, "IV$") ~ "4",
      TRUE ~ NA_character_
    ),
    GRADE = case_when(
      GRADE %in% c("1", "2") ~ "Start",
      GRADE %in% c("3", "4") ~ "End",
      TRUE ~ NA_character_
    ),
    GRADE = factor(GRADE, levels = c("Start", "End"), ordered = FALSE)
  )
table(seer_prime$GRADE)
```

SIZE: Making this numeric and then filtering implausible values, we can bin these ("≤20mm", "21–50mm", "51–100mm", ">100mm") if needed. 

```{r SIZE}
seer_prime <- seer_prime %>%
  mutate(
    SIZE = as.numeric(SIZE),
    SIZE = ifelse(SIZE > 0 & SIZE <= 200, SIZE, NA)
  )
summary(seer_prime$SIZE)
```

MARRY: Making this binary, only married or unmarried. 

```{r MARRY}
seer_prime <- seer_prime %>%
  mutate(
    MARRY = case_when(
      str_detect(MARRY, "Married") ~ "Married",
      TRUE ~ "Unmarried"
    ),
    MARRY = factor(MARRY)
  )
table(seer_prime$MARRY)
```

Recode RACETH to be three levels

```{r RACISM}
seer_prime <- seer_prime %>%
  mutate(
    RACETH = case_when(
      RACETH == "White" ~ "W",
      RACETH == "Black" ~ "B",
      TRUE ~ "O"  
    ),
    RACETH = factor(RACETH, levels = c("W", "B", "O"))
  )
```

Seeing how many cases are available now:

```{r Checking}
seer_prime <- seer_prime %>% filter(complete.cases(ID, REGION, STAGE, AGE, SEX, RACETH, GRADE, SIZE, YEAR, MARRY))
cat("Remaining complete cases:", nrow(seer_prime), "\n")
```

*Hierarchal Encoding*

To do hierarchal models in R, identifiers must be encoded as numeric integers (e.g., 1, 2, ..., N) for levels like REGION and ID.

```{r Hierarchy prep}
seer_prime <- seer_prime %>%
  mutate(
    REGION_ID = as.integer(factor(REGION)),
    PATIENT_ID = as.integer(factor(ID))
  )
```

Setting factor and checking data structure. 

```{r Data Structure set}
seer_prime <- seer_prime %>%
  mutate(
    AGE = factor(AGE),
    SEX = factor(SEX),
    RACETH = factor(RACETH),
  )
```

Inspect the data:

```{r Inspection}
str(seer_prime)
```

Code here so you can save it as CSV: 1238888 observations of 12 variables

```{r SAVING}
write.csv(seer_prime, "../data/clean/seer_nov10.csv", row.names = FALSE)
```

*Visualizations*

Bar Plot of STAGE and Region

```{r Visualization}
ggplot(seer_prime, aes(x = REGION, fill = STAGE)) +
  geom_bar(position = "dodge") +
  labs(
    title = "Cancer Stage Distribution by Region",
    x = "Region Type",
    y = "Number of Cases",
    fill = "Stage"
  ) +
  theme_minimal()
```

Box Plot for SIZE vs GRADE 

```{r}
ggplot(seer_prime, aes(x = GRADE, y = SIZE)) +
  geom_boxplot(fill = "#9ecae1") +
  labs(
    title = "Tumor Size by Grade",
    x = "Tumor Grade",
    y = "Tumor Size (mm)"
  ) +
  theme_minimal()
```

Box Plot for SIZE vs STAGE

```{r}
ggplot(seer_prime, aes(x = STAGE, y = SIZE)) +
  geom_boxplot(fill = "#a1d99b") +
  labs(
    title = "Tumor Size by Cancer Stage",
    x = "Cancer Stage",
    y = "Tumor Size (mm)"
  ) +
  theme_minimal()
```

Heatmap for REGION x STAGE

```{r}
seer_prime %>%
  count(REGION, STAGE) %>%
  ggplot(aes(x = REGION, y = STAGE, fill = n)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "#deebf7", high = "#08519c") +
  labs(
    title = "Heatmap of Region × Cancer Stage Counts",
    x = "Region",
    y = "Cancer Stage",
    fill = "Count"
  ) +
  theme_minimal()
```

Mean Tumor Size per Region

```{r}
seer_prime %>%
  group_by(REGION) %>%
  summarise(mean_size = mean(SIZE, na.rm = TRUE)) %>%
  ggplot(aes(x = reorder(REGION, mean_size), y = mean_size)) +
  geom_col(fill = "#6baed6") +
  coord_flip() +
  labs(
    title = "Average Tumor Size by Region",
    x = "Region",
    y = "Mean Tumor Size (mm)"
  ) +
  theme_minimal()
```

*Summary*:

We can see some issues from these plots, Large metro areas diagnose more cancers and tend to catch them earlier, as seen by the high volume of localized cases. Smaller and nonmetro regions face higher proportions of late-stage cancers, potentially due to limited access to care. Tumor size increases with stage but is less strongly associated with grade or region. The findings underscore healthcare access as a key determinant in early cancer detection. 

