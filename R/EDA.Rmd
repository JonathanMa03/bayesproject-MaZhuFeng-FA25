---
title: "Breast Exploratory Analysis"
author: "Jonathan Ma"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(stringr)
library(ggthemes)
library(scales)
```

Project Idea: Bayesian Hierarchal Model > Posterior Summary > Clustering. 

Data: Breast Cancer Data from SEER. 

Level via Tumor, Patient, and Region (Urban/Rural Code). 

We start with 5149008 observations of 12 variables (V#). 

*Level 1: Tumor*

V3: SEER stage (Localized, Regional, Distant). == STAGE

V7: Tumor Grade (Grade 1-4 or unknown). == GRADE

V10: EOD Tumor Size (1988+) == SIZE

V8: RX Summ—Surg Prim Site (Histology). == SITE

V9: Malignant/Benign indicator. == MBind

Remark: No Behavior Variable

*Level 2: Patient*

V1: Patient ID. == ID

V4: Binned Age group at diagnosis. == AGE

V5: Patient Sex. == SEX

V6: Race/Ethnicity. == RACETH

V11: Year of Diagnosis. == YEAR

V12: Marital Status. == MARRY

Remark: No Primary site variable

*Level 3: Region*

V2: Regional Area (Metro < 250k, Metro < 1m, Metro > 1m, Nonmetro adjacent, nonmetro nonadjacent, unknown). == REGION


```{r Data Loading}
seer <- read.delim("../data/raw/breastcancer.txt", sep = "\t", header = FALSE, stringsAsFactors = FALSE)
```

```{r Rename and NA drop}
# Rename and select the relevant variables
seer_prime <- seer %>%
  transmute(
    ID     = V1,
    REGION = V2,
    STAGE  = V3,
    AGE    = V4,
    SEX    = V5,
    RACETH = V6,
    GRADE  = V7,
    SITE   = V8,
    MBind  = V9,
    SIZE   = V10,
    YEAR   = V11,
    MARRY  = V12
  )

# Replace "Unknown" and "Blank(s)" with NA in character columns
seer_prime <- seer_prime %>%
  mutate(across(where(is.character), ~na_if(., "Unknown"))) %>%
  mutate(across(where(is.character), ~na_if(., "Blank(s)")))

# Filter for complete cases only
seer_prime <- seer_prime %>%
  filter(complete.cases(.))

# Print number and percentage of complete cases
total_cases <- nrow(seer)
complete_cases <- nrow(seer_prime)
percent_complete <- round(100 * complete_cases / total_cases, 2)

cat("Complete cases:", complete_cases, "out of", total_cases,
    sprintf("(%s%% complete)\n", percent_complete))
```

we have 209123 cases to work with (4.06% of the whole thing) after removing "Unknown" and "Blank(s)" Values.

Further cleaning is done via tabling all variables.

REGION: collapse and recode into ordered, interpretable regional factors, removes the Alaska/Hawaii “unknown” entries.

```{r REGION}
seer_prime <- seer_prime %>%
  mutate(
    REGION = case_when(
      str_detect(REGION, "1 million") ~ "Metro >1M",
      str_detect(REGION, "250,000") ~ "Metro 250k–1M",
      str_detect(REGION, "lt 250") ~ "Metro <250k",
      str_detect(REGION, "adjacent") ~ "Nonmetro Adjacent",
      str_detect(REGION, "not adjacent") ~ "Nonmetro Nonadjacent",
      TRUE ~ NA_character_
    ),
    REGION = factor(REGION,
                    levels = c("Metro >1M", "Metro 250k–1M", "Metro <250k",
                               "Nonmetro Adjacent", "Nonmetro Nonadjacent"))
  )
```

STAGE: restrict to tumors that are invasive (drop In situ, Unknown/unstaged).

```{r STAGE}
seer_prime <- seer_prime %>%
  mutate(
    STAGE = case_when(
      STAGE %in% c("Localized", "Regional", "Distant") ~ STAGE,
      TRUE ~ NA_character_
    ),
    STAGE = factor(STAGE, levels = c("Localized", "Regional", "Distant"))
  )
```

GRADE: extract numeric grade 1–4; drop cell‑line entries (“B‑cell”, “T‑cell” etc.).

```{r GRADE}
seer_prime <- seer_prime %>%
  mutate(
    GRADE = case_when(
      str_detect(GRADE, "I$") ~ "1",
      str_detect(GRADE, "II$") ~ "2",
      str_detect(GRADE, "III$") ~ "3",
      str_detect(GRADE, "IV$") ~ "4",
      TRUE ~ NA_character_
    ),
    GRADE = factor(GRADE, levels = c("1", "2", "3", "4"), ordered = TRUE)
  )
```

SITE: appears to be the histology variable, and breast cancer is "050". Issue: only 4000 are breast cancer, the majority are 998/999 which are unknown. I will not treat this variable for now

MBind: Leaving untreated as well, because I'm not sure how to deal with this:

```{r MBind}
table(seer_prime$MBind)
```

SIZE: Making this numeric and then filtering implausible values, we can bin these ("≤20mm", "21–50mm", "51–100mm", ">100mm") if needed. 

```{r SIZE}
seer_prime <- seer_prime %>%
  mutate(
    SIZE = as.numeric(SIZE),
    SIZE = ifelse(SIZE > 0 & SIZE <= 200, SIZE, NA)
  )
```

MARRY: Making this binary, only married or unmarried. 

```{r MARRY}
seer_prime <- seer_prime %>%
  mutate(
    MARRY = case_when(
      str_detect(MARRY, "Married") ~ "Married",
      TRUE ~ "Unmarried"
    ),
    MARRY = factor(MARRY)
  )
```

Seeing how many cases are available now:

```{r Checking}
seer_prime <- seer_prime %>% filter(complete.cases(ID, REGION, STAGE, AGE, SEX, RACETH, GRADE, SITE, MBind, SIZE, YEAR, MARRY))
cat("Remaining complete cases:", nrow(seer_prime), "\n")
```

*Hierarchal Encoding*

To do hierarchal models in R, identifiers must be encoded as numeric integers (e.g., 1, 2, ..., N) for levels like REGION and ID.

```{r Hierarchy prep}
seer_prime <- seer_prime %>%
  mutate(
    REGION_ID = as.integer(factor(REGION)),
    PATIENT_ID = as.integer(factor(ID))
  )
```

Setting factor and checking data structure. 

```{r Data Structure set}
seer_prime <- seer_prime %>%
  mutate(
    AGE = factor(AGE),
    SEX = factor(SEX),
    RACETH = factor(RACETH),
    YEAR = factor(YEAR),
  )
```

Inspect the data:

```{r Inspection}
str(seer_prime)
```

Code here so you can save it as CSV: 131782 observations of 14 variables

```{r SAVING}
write.csv(seer_prime, "../data/cleaned/seer_v1.csv", row.names = FALSE)
```

*Further Processing (if needed)*

To treat SITE and MBind

*Visualizations*

Bar Plot of STAGE and Region

```{r Visualization}
ggplot(seer_prime, aes(x = REGION, fill = STAGE)) +
  geom_bar(position = "dodge") +
  labs(
    title = "Cancer Stage Distribution by Region",
    x = "Region Type",
    y = "Number of Cases",
    fill = "Stage"
  ) +
  theme_minimal()
```

Box Plot for SIZE vs GRADE 

```{r}
ggplot(seer_prime, aes(x = GRADE, y = SIZE)) +
  geom_boxplot(fill = "#9ecae1") +
  labs(
    title = "Tumor Size by Grade",
    x = "Tumor Grade",
    y = "Tumor Size (mm)"
  ) +
  theme_minimal()
```

Box Plot for SIZE vs STAGE

```{r}
ggplot(seer_prime, aes(x = STAGE, y = SIZE)) +
  geom_boxplot(fill = "#a1d99b") +
  labs(
    title = "Tumor Size by Cancer Stage",
    x = "Cancer Stage",
    y = "Tumor Size (mm)"
  ) +
  theme_minimal()
```

Heatmap for REGION x STAGE

```{r}
seer_prime %>%
  count(REGION, STAGE) %>%
  ggplot(aes(x = REGION, y = STAGE, fill = n)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "#deebf7", high = "#08519c") +
  labs(
    title = "Heatmap of Region × Cancer Stage Counts",
    x = "Region",
    y = "Cancer Stage",
    fill = "Count"
  ) +
  theme_minimal()
```

Mean Tumor Size per Region

```{r}
seer_prime %>%
  group_by(REGION) %>%
  summarise(mean_size = mean(SIZE, na.rm = TRUE)) %>%
  ggplot(aes(x = reorder(REGION, mean_size), y = mean_size)) +
  geom_col(fill = "#6baed6") +
  coord_flip() +
  labs(
    title = "Average Tumor Size by Region",
    x = "Region",
    y = "Mean Tumor Size (mm)"
  ) +
  theme_minimal()
```

*Summary*:

We can see some issues from these plots:  

- For REGION we only have three levels: Metro>1m, Metro <250k, and Nonmetro. We can maybe make this into a binary variable for Urban/Rural since we don't have that many levels

- For GRADE, we only have Grade 1 and 4, no 2 or 3 data