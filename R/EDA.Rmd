---
title: "Breast Exploratory Analysis"
author: "Jonathan Ma"
date: "`r Sys.Date()`"
output:
  word_document:
    toc: true
    number_sections: true
---

\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(stringr)
library(ggthemes)
library(scales)
```

# Introduction

This exploratory data analysis (EDA) is the first step in our project pipeline:

1. Bayesian Hierarchical Modeling
2. Posterior Inference & Diagnostics
3. Clustering of Individual Risk Profiles

We use data from the [SEER Program](https://seer.cancer.gov/) focused on breast cancer cases, structured across three levels:

- **Level 1 (Tumor):** Tumor-specific details (e.g., stage, size, grade)
- **Level 2 (Patient):** Demographics and marital status
- **Level 3 (Region):** County-level metro/rural designations

# Data Structure and Levels

| Level    | Variable | Description                                    |
|----------|----------|------------------------------------------------|
| Tumor    | stage    | SEER stage: Localized, Regional, Distant       |
| Tumor    | grade    | Tumor grade: 1–4 or unknown                    |
| Tumor    | size     | EOD Tumor Size (mm)                            |
| Tumor    | site     | Tumor site (ICD code)                          |
| Patient  | id       | Patient identifier                             |
| Patient  | age      | Age group at diagnosis                         |
| Patient  | sex      | Biological sex                                 |
| Patient  | raceth   | Race/ethnicity                                 |
| Patient  | year     | Year of diagnosis                              |
| Patient  | marry    | Marital status                                 |
| Region   | region   | County-level metro/rural code                  |


```{r Data Loading}
seer <- read.delim("../data/raw/breastcancer.txt", sep = "\t", header = FALSE, stringsAsFactors = FALSE)
```

We replace "Unknown" and "Blank(s)" with `NA`, and then keep only complete cases:

```{r Rename}
seer_prime <- seer %>%
  transmute(
    id     = V1,
    region = V2,
    stage  = V3,
    age    = V4,
    sex    = V5,
    raceth = V6,
    grade  = V7,
    size   = V10,
    year   = V11,
    marry  = V12,
    site = V8
  )

seer_prime <- seer_prime %>%
  mutate(across(where(is.character), ~na_if(., "Unknown"))) %>%
  mutate(across(where(is.character), ~na_if(., "Blank(s)")))
```

## Is missing data more common in older patients?

```{r}
df <- seer_prime

df <- seer_prime %>%
  mutate(size_missing = is.na(size))

ggplot(df, aes(x = age, fill = size_missing)) +
  geom_bar(position = "fill") +
  labs(title = "Proportion of Missing Tumor Size by Age",
       y = "Proportion Missing",
       x = "Age Group",
       fill = "Size Missing") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Is missing data associated with Race/Ethnicity?

```{r}
table(df$raceth, is.na(df$size))
```

## is stage more likely to be missing in nonmetro rural areas?

```{r}
df <- df %>%
  mutate(grade_missing = is.na(grade),
         region_type = factor(region))

# Proportions
prop.table(table(df$region, df$grade_missing), 1)
```

Although we did not do a statistical test for MCAR, visual and tabular inspection clearly show patterns in missingness. Tumor size by age is non-uniform, with younger and older ends having higher missing rates. Missing rates also vary by racial group, with whites having notably higher missingness

## Selecting Complete Cases

```{r}
seer_prime <- seer_prime %>%
  filter(complete.cases(.))

total_cases <- nrow(seer)
complete_cases <- nrow(seer_prime)
percent_complete <- round(100 * complete_cases / total_cases, 2)

cat("Complete cases:", complete_cases, "out of", total_cases,
    sprintf("(%s%% complete)\n", percent_complete))
```

we have 209123 cases to work with (4.06% of the whole thing) after removing "Unknown" and "Blank(s)" Values.

Further cleaning is done via tabling all variables. 

## Cancer Site

We want to filter for top ten cancer sites (breast, lung, etc). We exclude 998 and 999 because they are unknown. The code is structured so we can switch sites.

```{r SITE}
seer_prime <- seer_prime %>%
  filter(!(site %in% c("998", "999")))

top_sites <- seer_prime %>%
  count(site, sort = TRUE) %>%
  slice_head(n = 10)

seer_prime <- seer_prime %>%
  filter(site %in% top_sites$site)

table(seer_prime$site)
```

## Region

REGION: collapse and recode into ordered, interpretable regional factors, removes the Alaska/Hawaii “unknown” entries.

```{r REGION}
seer_prime <- seer_prime %>%
  mutate(
    region = case_when(
      str_detect(region, "1 million") ~ "Large",
      str_detect(region, "lt 250") | str_detect(region, "250,000") ~ "Small",
      str_detect(region, "adjacent") | str_detect(region, "not adjacent") ~ "Nonmetro",
      TRUE ~ NA_character_
    ),
    region = factor(region, levels = c("Large", "Small", "Nonmetro"))
  )
table(seer_prime$region)
```

## Tumor Stage

STAGE: restrict to tumors that are invasive (drop In situ, Unknown/unstaged).

```{r STAGE}
seer_prime <- seer_prime %>%
  mutate(
    stage = case_when(
      stage %in% c("Localized", "Regional", "Distant") ~ stage,
      TRUE ~ NA_character_
    ),
    stage = factor(stage, levels = c("Localized", "Regional", "Distant"))
  )
table(seer_prime$stage)
```

## Tumor Grade

GRADE: extract numeric grade 1–4; drop cell‑line entries (“B‑cell”, “T‑cell” etc.). Convert them to Start (1/2) and End (3/4) since our model is logistic

```{r GRADE}
seer_prime <- seer_prime %>%
  mutate(
    grade = case_when(
      str_detect(grade, "I$") ~ "1",
      str_detect(grade, "II$") ~ "2",
      str_detect(grade, "III$") ~ "3",
      str_detect(grade, "IV$") ~ "4",
      TRUE ~ NA_character_
    ),
    grade = case_when(
      grade %in% c("1", "2") ~ "Start",
      grade %in% c("3", "4") ~ "End",
      TRUE ~ NA_character_
    ),
    grade = factor(grade, levels = c("Start", "End"), ordered = FALSE)
  )
table(seer_prime$grade)
```

## Tumor Size

SIZE: Making this numeric and then filtering implausible values, we can bin these ("≤20mm", "21–50mm", "51–100mm", ">100mm") if needed. 

```{r SIZE}
seer_prime <- seer_prime %>%
  mutate(
    size = as.numeric(size),
    size = ifelse(size > 0 & size <= 200, size, NA)
  )
summary(seer_prime$size)
```

## Marital Status

MARRY: Making this binary, only married or unmarried. 

```{r MARRY}
seer_prime <- seer_prime %>%
  mutate(
    marry = case_when(
      str_detect(marry, "Married") ~ "Married",
      TRUE ~ "Unmarried"
    ),
    marry = factor(marry)
  )
table(seer_prime$marry)
```

## Race

Recode RACETH to be three levels

```{r RACISM}
seer_prime <- seer_prime %>%
  mutate(
    raceth = case_when(
      raceth == "White" ~ "W",
      raceth == "Black" ~ "B",
      TRUE ~ "O"  
    ),
    raceth = factor(raceth, levels = c("W", "B", "O"))
  )
table(seer_prime$raceth)
```

## Complete Summary of available data

Seeing how many cases are available now:

```{r Checking}
seer_prime <- seer_prime %>% filter(complete.cases(id, region, stage, age, sex, raceth, grade, size, site, marry, year))
cat("Remaining complete cases:", nrow(seer_prime), "\n")
```

# Hierarchal Encoding

To do hierarchal models in R, identifiers must be encoded as numeric integers (e.g., 1, 2, ..., N) for levels like REGION and ID.

```{r Hierarchy prep}
seer_prime <- seer_prime %>%
  mutate(
    regionid = as.integer(factor(region)),
    patientid = as.integer(factor(id))
  )
```

Setting factor and checking data structure. 

```{r Data Structure set}
seer_prime <- seer_prime %>%
  mutate(
    age = factor(age),
    sex = factor(sex),
    raceth = factor(raceth),
  )
```

Inspect the data:

```{r Inspection}
str(seer_prime)
```

# Saving Final Data

Code here so you can save it as CSV:  37530 observations of 13 variables

```{r SAVING}
write.csv(seer_prime, "../data/clean/seer_nov13.csv", row.names = FALSE)
```