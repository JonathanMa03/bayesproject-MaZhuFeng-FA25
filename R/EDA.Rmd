Project Idea: Bayesian Hierarchal Clustering Model pre-COVID vs post-COVID

Loading data from both years, find common questions, add a year indicator

```{r Data Loading}
library(tidyverse)
library(readr)
library(forcats)
library(ggplot2)
library(janitor)

yrbs19 <- read_csv("../data/raw/yrbs2019.csv") %>% clean_names() %>% mutate(year = 2019)
yrbs21 <- read_csv("../data/raw/yrbs2021.csv") %>% clean_names() %>% mutate(year = 2021)

# List of variables to keep
vars_to_keep <- c(
  "q1", "q2", "q3", "q4", # Grouping
  "q30", "q31", "q32", "q33", "q34", "q35", "q36", "q37", # substance use
  "q60", "q76", #sleep and screentime
  "q77", "q78", "q79", #bullying/school safety
  "q80", "q81", "q82", "q83", "q84"         # Mental health
)

# Select only matching variables
yrbs19_selected <- yrbs19 %>% select(all_of(vars_to_keep), year)
yrbs21_selected <- yrbs21 %>% select(all_of(vars_to_keep), year)

# Combine
yrbs_combined <- bind_rows(yrbs19_selected, yrbs21_selected)
```

We selected these variables to begin with:

- Q30–Q37: Substance use
- Q60, Q76: Sleep and screen
- Q77–Q79: Bullying / school safety
- Q80–Q84: Mental health
- Q1–Q4: Use as hierarchical grouping variables

compute % of complete cases

```{r Checking Integrity}
complete_pct <- mean(complete.cases(yrbs_combined)) * 100
cat(sprintf("Percentage of rows without any NA: %.2f%%\n", complete_pct))
```

We have 45% of cases complete, with 13677 observations in 2019 and 17232 observations in 2021. Now I will filter complete cases only, and balance 2021 to match 2019 via a naive approach since we don't have information to "match" observations. REMARK: in processing write about information loss due to this naive approach. 

```{r Balancing}
# Keep complete cases only
yrbs_complete <- yrbs_combined %>%
  filter(complete.cases(.))

# Check counts by year
table(yrbs_complete$year)

# Downsample 2021 to match 2019's count
n_2019 <- yrbs_complete %>% filter(year == 2019) %>% nrow()

yrbs_balanced <- yrbs_complete %>%
  group_by(year) %>%
  slice_sample(n = min(n_2019)) %>%
  ungroup()

table(yrbs_balanced$year)

```

On this analysis, we have 23 variables with 13714 observations. 

*TODO* : We can take one of two approaches

- Conduct PCA to choose relevant variables
- Feature Engineer via grouping mental health variables, etc.

Build the model on Year 2019, apply the model to Year 2021

Grouping variable: Either Q1 (Age) or Q3 (Sexual Identity), due to balance

```{r Identifying Group Variable}
table(yrbs_balanced$year, yrbs_balanced$q1)
table(yrbs_balanced$year, yrbs_balanced$q3)

par(mfrow = c(1, 2))
hist(yrbs_balanced$q1)
hist(yrbs_balanced$q3)
```

Running PCA for Mental health, substance use, and bullying variables

```{r PCA for Risk Variables}
library(FactoMineR)
library(dplyr)

substance_vars <- yrbs_balanced %>% select(paste0("q", 30:37))
pca_substance <- PCA(substance_vars, graph = TRUE)

bullying_vars <- yrbs_balanced %>% select(paste0("q", 77:79))
pca_bullying <- PCA(bullying_vars, graph = TRUE)

mental_vars <- yrbs_balanced %>% select(paste0("q", 80:84))
pca_mental <- PCA(mental_vars, graph = TRUE)
```
PCA shows that 

for substance use, Q32, Q33, and Q37 are closest to the first dimension

```{r PCA Substance}
library(ggpubr)
library(factoextra)

fviz_pca_var(pca_substance, col.var = "contrib", repel = TRUE)
print(pca_substance$var$contrib)
```

for school safety, either Q78 (bullying) or Q79 (feeling unsafe) could be retained

```{r PCA Bullying}
fviz_pca_var(pca_bullying, col.var = "contrib", repel = TRUE)
print(pca_bullying$var$contrib)
```

for mental health, 
Q80 (e.g., felt sad/hopeless) is the strongest on Dim 1—likely the most representative.
Q82 (seriously considered suicide) is distinct and could be retained for a different dimension of mental health risk.

```{r PCA Mental}
fviz_pca_var(pca_mental, col.var = "contrib", repel = TRUE)
print(pca_mental$var$contrib)
```

Summary:

Keep *Q32* (vaping) for general use behavior or Q37 (prescription misuse) for distinct risk behavior.

Pick Q77 for the general bullying construct or *Q78* if your focus is cyber/social risk (more modern, distinct cluster dimension).

Keep *Q80* (broad depressive mood marker) or keep Q82 (suicide planning) if you want a separate dimension of suicidal intent.

Final Dataset as of 11/9:
Indicat0r Variable: 
Year (For year 2019 or 2021)

Grouping Variable: 
Q3 (Sexual Identity)

Covariates: 
Q32 (Electronic Vape Usage)
Q60 (Hours of Sleep)
Q76 (Hours of screen time)
Q78 (Electronically bullied)
Q80 (Felt sad or hopeless)

Once we get the final list of variables, I'll go in and replace the q# with a better name.
