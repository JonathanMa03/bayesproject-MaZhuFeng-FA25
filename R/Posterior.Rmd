---
title: "Posterior Summary"
author: "Jonathan Ma"
date: "`r Sys.Date()`"
output:
  word_document:
    toc: true
    number_sections: true
---

\newpage

```{r setup, include=FALSE, messages=FALSE}
knitr::opts_chunk$set(echo = TRUE)
brm_model2 <- readRDS("../R/breast_model.rds")
library(dplyr)
library(ggplot2)
library(sjPlot)
library(brms)
library(tidyr)
df <- read.csv("../data/clean/seer_df2.csv", sep = ",", header = TRUE, stringsAsFactors = TRUE)
```

# Posterior Summary

This section summarizes the estimated posterior distributions of the model parameters, including fixed and random effects. We compute point estimates, credible intervals, and derive odds ratios and intra-class correlation metrics to assess variance partitioning.

## Summary 

The following shows the first few rows of the full posterior summary for all parameters, including fixed effects, group-level effects, and auxiliary parameters.


```{r Posterior Summary, echo=TRUE}
posterior_summary <- posterior_summary(brm_model2)
head(posterior_summary)
```

## Fixed Effects

Below we visualize the fixed effect posterior estimates and 95% credible intervals. Coefficients are on the log-odds scale. Positive values indicate increased odds of late-stage diagnosis.

```{r Fixed Effects, echo=TRUE}
fe <- fixef(brm_model2, probs = c(0.025, 0.975))
head(fe)

plot_model(brm_model2, type = "est", show.values = TRUE, value.offset = 0.3)
```

## Random Effects (group level variation)

The following summarizes the estimated random intercepts (shrinkage effects) for patient and region. These account for individual and regional variability unexplained by covariates.

```{r Random Effects, echo=TRUE}
re <- ranef(brm_model2)
head(re$patientid)
head(re$regionid)
```

## Odds Ratios

The odds ratio (OR) is the exponentiated posterior mean (or median) of each coefficient.

```{r OR, echo=TRUE}
odds_ratios <- exp(fe)
odds_df <- as.data.frame(odds_ratios)
odds_df <- odds_df[order(abs(odds_df$Estimate - 1), decreasing = TRUE), ]
head(odds_df, 10)
```

## Marginal Effects 

```{r Marginal Effects, echo=TRUE}
library(dplyr)
library(purrr)

# Get conditional effects
me_list <- conditional_effects(brm_model2)

# Safe cleaning function
clean_ce <- function(df, varname) {
  if ("effect1__" %in% names(df) && !is.character(df$effect1__)) {
    df$effect1__ <- as.character(df$effect1__)
  }
  df$variable <- varname
  df
}

# Apply cleaning to all conditional effects
me_combined <- bind_rows(
  lapply(names(me_list), function(v) clean_ce(me_list[[v]], v))
)

# Compute range and summarize by variable
me_summary <- me_combined %>%
  mutate(range = upper__ - lower__) %>%
  group_by(variable) %>%
  summarise(
    avg_range = mean(range, na.rm = TRUE),
    avg_estimate = mean(estimate__, na.rm = TRUE),
    n_levels = n()
  ) %>%
  arrange(desc(avg_range))

# Show top 10 most variable effects
head(me_summary, 10)
```

## Shrinkage EFfects

```{r Shrinkage Effects, echo=TRUE}
patient_re <- as.data.frame(re$patientid)
region_re <- as.data.frame(re$regionid)
patient_re$group <- rownames(re$patientid)
region_re$group <- rownames(re$regionid)

# patient-level shrinkage
top_patient <- patient_re %>%
  arrange(desc(abs(Estimate.Intercept))) %>%
  slice(1:30)  # top 30 most extreme patients

ggplot(top_patient, aes(x = reorder(group, Estimate.Intercept), 
                        y = Estimate.Intercept)) +
  geom_point() +
  geom_errorbar(aes(ymin = Q2.5.Intercept, ymax = Q97.5.Intercept), width = 0.2) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  coord_flip() +
  labs(
    title = "Shrinkage of Patient-Level Intercepts",
    x = "Patient ID",
    y = "Estimated Intercept (log-odds scale)"
  ) +
  theme_minimal()

# region-level shrinkage
top_region <- region_re %>%
  arrange(desc(abs(Estimate.Intercept)))

ggplot(top_region, aes(x = reorder(group, Estimate.Intercept), 
                        y = Estimate.Intercept)) +
  geom_point() +
  geom_errorbar(aes(ymin = Q2.5.Intercept, ymax = Q97.5.Intercept), width = 0.2) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  coord_flip() +
  labs(
    title = "Shrinkage of Region-Level Intercepts",
    x = "Region ID",
    y = "Estimated Intercept (log-odds scale)"
  ) +
  theme_minimal()
```

## Raw vs Shrunk Estimates

Red points represent posterior-predicted probabilities, which incorporate both observed data and model priors. Blue points are empirical averages (raw rate). Posterior estimates are shrunk toward the global mean, especially for small regions.

```{r Comparison}
raw_region <- df %>%
  group_by(regionid) %>%
  summarise(
    raw_rate = mean(latestage),
    n = n()
  )

region_re <- as.data.frame(ranef(brm_model2)$regionid)
region_re$regionid <- as.integer(rownames(ranef(brm_model2)$regionid))
region_post <- region_re %>%
  select(regionid, estimate = Estimate.Intercept,
         lower = Q2.5.Intercept, upper = Q97.5.Intercept)

region_compare <- left_join(raw_region, region_post, by = "regionid") %>%
  mutate(
    posterior_prob = plogis(estimate),  # convert log-odds to probability
    lower_prob = plogis(lower),
    upper_prob = plogis(upper)
  )

ggplot(region_compare, aes(x = reorder(regionid, raw_rate))) +
  geom_point(aes(y = raw_rate), color = "blue", size = 2, alpha = 0.6) +
  geom_point(aes(y = posterior_prob), color = "red", size = 2, alpha = 0.6) +
  geom_errorbar(aes(ymin = lower_prob, ymax = upper_prob), color = "red", width = 0.2, alpha = 0.5) +
  coord_flip() +
  labs(
    title = "Shrinkage: Raw vs Posterior Region-Level Late-Stage Probabilities",
    x = "Region ID",
    y = "Probability of Late-Stage Diagnosis",
    caption = "Blue = raw rate, Red = posterior mean Â± 95% CI"
  ) +
  theme_minimal()
```

## Intra-Class Correlation

ICC (intra-class correlation) quantifies the proportion of total variance attributable to grouping structure. Here we compute ICC for both patients and regions.

```{r ICC, echo=TRUE, warnings=FALSE}
posterior <- as_draws_df(brm_model2)
posterior <- posterior %>%
  mutate(
    var_patient = sd_patientid__Intercept^2,
    var_region  = sd_regionid__Intercept^2,
    var_resid   = (pi^2) / 3,

    ICC_patientid = var_patient / (var_patient + var_region + var_resid),
    ICC_regionid  = var_region  / (var_patient + var_region + var_resid)
  )
# Compute posterior summaries
icc_summary <- posterior %>%
  summarise(
    SD_patient = mean(sd_patientid__Intercept),
    SD_region = mean(sd_regionid__Intercept),
    
    ICC_patient_mean = mean(ICC_patientid),
    ICC_patient_low  = quantile(ICC_patientid, 0.025),
    ICC_patient_high = quantile(ICC_patientid, 0.975),
    
    ICC_region_mean = mean(ICC_regionid),
    ICC_region_low  = quantile(ICC_regionid, 0.025),
    ICC_region_high = quantile(ICC_regionid, 0.975)
  )

# Create simple summary table
icc_table <- tibble(
  Group = c("Patient", "Region"),
  SD = c(icc_summary$SD_patient, icc_summary$SD_region),
  ICC = c(icc_summary$ICC_patient_mean, icc_summary$ICC_region_mean),
  CI = c(
    sprintf("[%.3f, %.3f]", icc_summary$ICC_patient_low, icc_summary$ICC_patient_high),
    sprintf("[%.3f, %.3f]", icc_summary$ICC_region_low, icc_summary$ICC_region_high)
  )
)

knitr::kable(icc_table, caption = "Posterior Intra-Class Correlation Estimates")
```

```{r ICC Density, echo=TRUE}
posterior %>%
  select(ICC_patientid, ICC_regionid) %>%
  pivot_longer(everything(), names_to = "Level", values_to = "ICC") %>%
  ggplot(aes(x = ICC, fill = Level)) +
  geom_density(alpha = 0.5) +
  labs(title = "Posterior ICC Distributions",
       x = "ICC", y = "Density") +
  theme_minimal()
```

