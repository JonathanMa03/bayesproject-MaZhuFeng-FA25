---
title: "Posterior Summary"
author: "Jonathan Ma"
date: "`r Sys.Date()`"
output:
  word_document:
    toc: true
    number_sections: true
---

\newpage

```{r setup, include=FALSE, messages=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE, fig.width=6, fig.height=4)
brm_model2 <- readRDS("../R/breast_model.rds")
library(dplyr)
library(ggplot2)
library(sjPlot)
library(brms)
library(tidyr)
df <- read.csv("../data/clean/seer_df2.csv", sep = ",", header = TRUE, stringsAsFactors = TRUE)
```

# Posterior Summary

This section summarizes the estimated posterior distributions of the model parameters, including fixed and random effects. We compute point estimates, credible intervals, and derive odds ratios and intra-class correlation metrics to assess variance partitioning.

## Summary 

The following shows the first few rows of the full posterior summary for all parameters, including fixed effects, group-level effects, and auxiliary parameters.


```{r Posterior Summary}
posterior_summary <- posterior_summary(brm_model2)
head(posterior_summary)
```

## Fixed Effects

Below we visualize the fixed effect posterior estimates and 95% credible intervals. Coefficients are on the log-odds scale. Positive values indicate increased odds of late-stage diagnosis.

```{r Fixed Effects}
fe <- fixef(brm_model2, probs = c(0.025, 0.975))
head(fe)

plot_model(brm_model2, type = "est", show.values = TRUE, value.offset = 0.3)
```

## Random Effects (group level variation)

The following summarizes the estimated random intercepts (shrinkage effects) for patient and region. These account for individual and regional variability unexplained by covariates.

```{r Random Effects}
re <- ranef(brm_model2)
head(re$patientid)
head(re$regionid)
```

## Odds Ratios

The odds ratio (OR) is the exponentiated posterior mean (or median) of each coefficient.

```{r OR}
odds_ratios <- exp(fe)
odds_df <- as.data.frame(odds_ratios)
odds_df <- odds_df[order(abs(odds_df$Estimate - 1), decreasing = TRUE), ]
head(odds_df, 10)
```

## Marginal Effects 

```{r Marginal Effects}
library(dplyr)
library(purrr)

# Get conditional effects
me_list <- conditional_effects(brm_model2)

# Safe cleaning function
clean_ce <- function(df, varname) {
  if ("effect1__" %in% names(df) && !is.character(df$effect1__)) {
    df$effect1__ <- as.character(df$effect1__)
  }
  df$variable <- varname
  df
}

# Apply cleaning to all conditional effects
me_combined <- bind_rows(
  lapply(names(me_list), function(v) clean_ce(me_list[[v]], v))
)

# Compute range and summarize by variable
me_summary <- me_combined %>%
  mutate(range = upper__ - lower__) %>%
  group_by(variable) %>%
  summarise(
    avg_range = mean(range, na.rm = TRUE),
    avg_estimate = mean(estimate__, na.rm = TRUE),
    n_levels = n()
  ) %>%
  arrange(desc(avg_range))

# Show top 10 most variable effects
head(me_summary, 10)
```

## Shrinkage EFfects

```{r Shrinkage Effects}
patient_re <- as.data.frame(re$patientid)
region_re <- as.data.frame(re$regionid)
patient_re$group <- rownames(re$patientid)
region_re$group <- rownames(re$regionid)

# patient-level shrinkage
top_patient <- patient_re %>%
  arrange(desc(abs(Estimate.Intercept))) %>%
  slice(1:30)  # top 30 most extreme patients

ggplot(top_patient, aes(x = reorder(group, Estimate.Intercept), 
                        y = Estimate.Intercept)) +
  geom_point() +
  geom_errorbar(aes(ymin = Q2.5.Intercept, ymax = Q97.5.Intercept), width = 0.2) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  coord_flip() +
  labs(
    title = "Shrinkage of Patient-Level Intercepts",
    x = "Patient ID",
    y = "Estimated Intercept (log-odds scale)"
  ) +
  theme_minimal()

# region-level shrinkage
top_region <- region_re %>%
  arrange(desc(abs(Estimate.Intercept)))

ggplot(top_region, aes(x = reorder(group, Estimate.Intercept), 
                        y = Estimate.Intercept)) +
  geom_point() +
  geom_errorbar(aes(ymin = Q2.5.Intercept, ymax = Q97.5.Intercept), width = 0.2) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  coord_flip() +
  labs(
    title = "Shrinkage of Region-Level Intercepts",
    x = "Region ID",
    y = "Estimated Intercept (log-odds scale)"
  ) +
  theme_minimal()
```

## Raw vs Shrunk Estimates

Red points represent posterior-predicted probabilities, which incorporate both observed data and model priors. Blue points are empirical averages (raw rate). Posterior estimates are shrunk toward the global mean, especially for small regions.

```{r Comparison}
raw_region <- df %>%
  group_by(regionid) %>%
  summarise(
    raw_rate = mean(latestage),
    n = n()
  )

region_re <- as.data.frame(ranef(brm_model2)$regionid)
region_re$regionid <- as.integer(rownames(ranef(brm_model2)$regionid))
region_post <- region_re %>%
  select(regionid, estimate = Estimate.Intercept,
         lower = Q2.5.Intercept, upper = Q97.5.Intercept)

region_compare <- left_join(raw_region, region_post, by = "regionid") %>%
  mutate(
    posterior_prob = plogis(estimate),  # convert log-odds to probability
    lower_prob = plogis(lower),
    upper_prob = plogis(upper)
  )

ggplot(region_compare, aes(x = reorder(regionid, raw_rate))) +
  geom_point(aes(y = raw_rate), color = "blue", size = 2, alpha = 0.6) +
  geom_point(aes(y = posterior_prob), color = "red", size = 2, alpha = 0.6) +
  geom_errorbar(aes(ymin = lower_prob, ymax = upper_prob), color = "red", width = 0.2, alpha = 0.5) +
  coord_flip() +
  labs(
    title = "Shrinkage: Raw vs Posterior Region-Level Late-Stage Probabilities",
    x = "Region ID",
    y = "Probability of Late-Stage Diagnosis",
    caption = "Blue = raw rate, Red = posterior mean Â± 95% CI"
  ) +
  theme_minimal()
```

## Intra-Class Correlation

ICC (intra-class correlation) quantifies the proportion of total variance attributable to grouping structure. Here we compute ICC for both patients and regions.

```{r ICC}
posterior <- as_draws_df(brm_model2)
posterior <- posterior %>%
  mutate(
    var_patient = sd_patientid__Intercept^2,
    var_region  = sd_regionid__Intercept^2,
    var_resid   = (pi^2) / 3,

    ICC_patientid = var_patient / (var_patient + var_region + var_resid),
    ICC_regionid  = var_region  / (var_patient + var_region + var_resid)
  )
# Compute posterior summaries
icc_summary <- posterior %>%
  summarise(
    SD_patient = mean(sd_patientid__Intercept),
    SD_region = mean(sd_regionid__Intercept),
    
    ICC_patient_mean = mean(ICC_patientid),
    ICC_patient_low  = quantile(ICC_patientid, 0.025),
    ICC_patient_high = quantile(ICC_patientid, 0.975),
    
    ICC_region_mean = mean(ICC_regionid),
    ICC_region_low  = quantile(ICC_regionid, 0.025),
    ICC_region_high = quantile(ICC_regionid, 0.975)
  )

# Create simple summary table
icc_table <- tibble(
  Group = c("Patient", "Region"),
  SD = c(icc_summary$SD_patient, icc_summary$SD_region),
  ICC = c(icc_summary$ICC_patient_mean, icc_summary$ICC_region_mean),
  CI = c(
    sprintf("[%.3f, %.3f]", icc_summary$ICC_patient_low, icc_summary$ICC_patient_high),
    sprintf("[%.3f, %.3f]", icc_summary$ICC_region_low, icc_summary$ICC_region_high)
  )
)

knitr::kable(icc_table, caption = "Posterior Intra-Class Correlation Estimates")
```

```{r ICC Density}
posterior %>%
  select(ICC_patientid, ICC_regionid) %>%
  pivot_longer(everything(), names_to = "Level", values_to = "ICC") %>%
  ggplot(aes(x = ICC, fill = Level)) +
  geom_density(alpha = 0.5) +
  labs(title = "Posterior ICC Distributions",
       x = "ICC", y = "Density") +
  theme_minimal()
```

# Preparing Data for Clustering

We want to do BGMM, so we need to standardizee values after extracting. These dfs are named and exported:

- dfRE_P is the best candidate for patient-level clustering with BGMM.

- dfRE_R is too small (3 obs), so not suited for BGMM, can just descriptively summarize it.

- dfFE and dfOR match in size and likely map onto your 27 predictors 

- dfPOST has ~3,000 rows

Maybe run PCA before clustering?

Posterior Summary:

```{r dfPOST}
dfPOST <- as.data.frame(posterior_summary)
dfPOST <- tibble::rownames_to_column(dfPOST, var = "Parameter")
dfPOST <- dfPOST %>%
  mutate(shrinkage = Q97.5 - Q2.5)
```

Fixed Effects:

```{r dfFE}
dfFE <- as.data.frame(fe)
dfFE <- tibble::rownames_to_column(dfFE, var = "Predictor")
dfFE <- dfFE %>%
  mutate(shrinkage = Q97.5 - Q2.5)
```

Patient Random Effects:

```{r dfRE_P}
dfRE_P <- as.data.frame(re$patientid)
dfRE_P <- tibble::rownames_to_column(dfRE_P, var = "PatientID")
dfRE_P <- dfRE_P %>%
  mutate(shrinkage = Q97.5.Intercept - Q2.5.Intercept)
```

Region Random Effects:

```{r dfRE_R}
dfRE_R <- as.data.frame(re$regionid)
dfRE_R <- tibble::rownames_to_column(dfRE_R, var = "RegionID")
dfRE_R <- dfRE_R %>%
  mutate(shrinkage = Q97.5.Intercept - Q2.5.Intercept)
```

Marginal Effects:

```{r dfME}
dfME <- me_combined %>%
  select(variable, effect1__, estimate__, se__, lower__, upper__) %>%
  rename(
    Level = effect1__,
    Estimate = estimate__,
    SE = se__,
    Lower = lower__,
    Upper = upper__
  ) %>%
  mutate(shrinkage = Upper - Lower)
```

Odds Ratios:

```{r dfOR}
dfOR <- odds_df %>%
  tibble::rownames_to_column(var = "Predictor") %>%
  mutate(
    logOR = log(Estimate),
    shrinkage = Q97.5 - Q2.5
  )
```

## Saving Data for Clustering

```{r Standardize and Save}
standardize_df <- function(df, id_col = NULL) {
  if (!is.null(id_col)) {
    ids <- df[[id_col]]
    num_data <- df %>% select(where(is.numeric))
    scaled_data <- as.data.frame(scale(num_data))
    scaled_data[[id_col]] <- ids
    return(scaled_data)
  } else {
    return(as.data.frame(scale(df %>% select(where(is.numeric)))))
  }
}

dfPOST_std <- standardize_df(dfPOST, id_col = "Parameter")
write.csv(dfPOST_std, "../data/clean/dfPOST.csv", row.names = FALSE)

dfFE_std <- standardize_df(dfFE, id_col = "Predictor")
write.csv(dfFE_std, "../data/clean/dfFE.csv", row.names = FALSE)

dfRE_P_std <- standardize_df(dfRE_P, id_col = "PatientID")
write.csv(dfRE_P_std, "../data/clean/dfRE_P.csv", row.names = FALSE)

dfRE_R_std <- standardize_df(dfRE_R, id_col = "RegionID")
write.csv(dfRE_R_std, "../data/clean/dfRE_R.csv", row.names = FALSE)

dfME_std <- standardize_df(dfME)
write.csv(dfME_std, "../data/clean/dfME.csv", row.names = FALSE)

dfOR_std <- standardize_df(dfOR, id_col = "Predictor")
write.csv(dfOR_std, "../data/clean/dfOR.csv", row.names = FALSE)
```
