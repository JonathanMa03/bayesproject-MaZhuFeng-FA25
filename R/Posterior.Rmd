---
title: "Posterior Summary"
author: "Jonathan Ma"
date: "`r Sys.Date()`"
output:
  word_document:
    toc: true
    number_sections: true
---

\newpage

```{r setup, include=FALSE, messages=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE, fig.width=6, fig.height=4)
brm_model2 <- readRDS("../R/breast_model.rds")
library(dplyr)
library(ggplot2)
library(sjPlot)
library(brms)
library(tidyr)
df <- read.csv("../data/clean/seer_df2.csv", sep = ",", header = TRUE, stringsAsFactors = TRUE)
```

# Posterior Summary

This section summarizes the estimated posterior distributions of the model parameters, including fixed and random effects. We compute point estimates, credible intervals, and derive odds ratios and intra-class correlation metrics to assess variance partitioning.

## Summary 

The following shows the first few rows of the full posterior summary for all parameters, including fixed effects, group-level effects, and auxiliary parameters.


```{r Posterior Summary}
posterior_summary <- posterior_summary(brm_model2)
head(posterior_summary)
```

## Fixed Effects

Below we visualize the fixed effect posterior estimates and 95% credible intervals. Coefficients are on the log-odds scale. Positive values indicate increased odds of late-stage diagnosis.

```{r Fixed Effects}
fe <- fixef(brm_model2, probs = c(0.025, 0.975))
plot_model(brm_model2, type = "est", show.values = TRUE, value.offset = 0.3)
```

The odds ratio plot displays the estimated likelihood of being diagnosed at a late stage of cancer across various predictors, with 95% confidence intervals. Values above 1 indicate higher odds of late-stage diagnosis, while values below 1 suggest lower odds. Younger patients—particularly those aged 01–04, 05–09, 10–14, and 15–19 years—have odds ratios well below 1, indicating significantly lower risk of late-stage diagnosis. In contrast, certain middle-aged groups, such as 35–39 and 50–54 years, show elevated odds ratios above 2 or even 3, suggesting increased risk. Gender and marital status also play a role: male and unmarried patients are more likely to be diagnosed late. Notably, one covariate possibly related to tumor size or diagnosis year has an extremely high odds ratio of over 400, indicating a strong association with late-stage detection, though such a large value may suggest issues like rare events or data sparsity. 

## Random Effects (group level variation)

These posterior summaries indicate that region-level effects are weak or negligible in influencing late-stage diagnosis once individual-level variables are accounted for. The wide intervals reflect uncertainty, possibly due to small sample sizes within regions or limited regional variation.

```{r Random Effects}
re <- ranef(brm_model2)
head(re$regionid)
```

## Odds Ratios

The odds ratio (OR) is the exponentiated posterior mean (or median) of each coefficient. This table highlights the most influential predictors in the model. Strong, well-estimated effects include early tumor grade, other race, and tumor size. Age effects are mixed, with older adults generally at higher risk, but credible intervals widen in extreme age groups due to fewer observations.

```{r OR}
odds_ratios <- exp(fe)
odds_df <- as.data.frame(odds_ratios)
odds_df <- odds_df[order(abs(odds_df$Estimate - 1), decreasing = TRUE), ]
head(odds_df, 10)
```

## Marginal Effects 

The marginal effects table confirms that tumor size and grade are the strongest predictors of the outcome. Age and race are meaningful, but less dominant. Sex, marital status, and year exert smaller effects. The magnitude and range of these effects help prioritize which variables matter most for prediction and interpretation.

```{r Marginal Effects}
library(dplyr)
library(purrr)

# Get conditional effects
me_list <- conditional_effects(brm_model2)

# Safe cleaning function
clean_ce <- function(df, varname) {
  if ("effect1__" %in% names(df) && !is.character(df$effect1__)) {
    df$effect1__ <- as.character(df$effect1__)
  }
  df$variable <- varname
  df
}

# Apply cleaning to all conditional effects
me_combined <- bind_rows(
  lapply(names(me_list), function(v) clean_ce(me_list[[v]], v))
)

# Compute range and summarize by variable
me_summary <- me_combined %>%
  mutate(range = upper__ - lower__) %>%
  group_by(variable) %>%
  summarise(
    avg_range = mean(range, na.rm = TRUE),
    avg_estimate = mean(estimate__, na.rm = TRUE),
    n_levels = n()
  ) %>%
  arrange(desc(avg_range))

# Show top 10 most variable effects
head(me_summary, 10)
```

## Shrinkage EFfects

The shrinkage plots illustrate the estimated patient- and region-level random intercepts on the log-odds scale, capturing unobserved heterogeneity after accounting for covariates. At the patient level, there is substantial variation, with some individuals showing highly negative intercepts (indicating much lower odds of the outcome) and others showing strongly positive intercepts (indicating much higher odds), suggesting that latent individual-level factors significantly influence outcome risk. These estimates are subject to shrinkage, where extreme values are pulled toward the population mean to stabilize inference. In contrast, the region-level intercepts exhibit minimal variability: all three regions have posterior means near zero with wide credible intervals that span zero, indicating no strong regional effects after adjusting for other variables. Together, the plots reinforce that most of the residual variation lies at the patient level, not the regional level, justifying the hierarchical structure of the model.

```{r Shrinkage Effects}
patient_re <- as.data.frame(re$patientid)
region_re <- as.data.frame(re$regionid)
patient_re$group <- rownames(re$patientid)
region_re$group <- rownames(re$regionid)

# patient-level shrinkage
top_patient <- patient_re %>%
  arrange(desc(abs(Estimate.Intercept))) %>%
  slice(1:30)  # top 30 most extreme patients

ggplot(top_patient, aes(x = reorder(group, Estimate.Intercept), 
                        y = Estimate.Intercept)) +
  geom_point() +
  geom_errorbar(aes(ymin = Q2.5.Intercept, ymax = Q97.5.Intercept), width = 0.2) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  coord_flip() +
  labs(
    title = "Shrinkage of Patient-Level Intercepts",
    x = "Patient ID",
    y = "Estimated Intercept (log-odds scale)"
  ) +
  theme_minimal()

# region-level shrinkage
top_region <- region_re %>%
  arrange(desc(abs(Estimate.Intercept)))

ggplot(top_region, aes(x = reorder(group, Estimate.Intercept), 
                        y = Estimate.Intercept)) +
  geom_point() +
  geom_errorbar(aes(ymin = Q2.5.Intercept, ymax = Q97.5.Intercept), width = 0.2) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  coord_flip() +
  labs(
    title = "Shrinkage of Region-Level Intercepts",
    x = "Region ID",
    y = "Estimated Intercept (log-odds scale)"
  ) +
  theme_minimal()
```

## Raw vs Shrunk Estimates

Red points represent posterior-predicted probabilities, which incorporate both observed data and model priors. Blue points are empirical averages (raw rate). Posterior estimates are shrunk toward the global mean, especially for small regions.

```{r Comparison}
raw_region <- df %>%
  group_by(regionid) %>%
  summarise(
    raw_rate = mean(latestage),
    n = n()
  )

region_re <- as.data.frame(ranef(brm_model2)$regionid)
region_re$regionid <- as.integer(rownames(ranef(brm_model2)$regionid))
region_post <- region_re %>%
  select(regionid, estimate = Estimate.Intercept,
         lower = Q2.5.Intercept, upper = Q97.5.Intercept)

region_compare <- left_join(raw_region, region_post, by = "regionid") %>%
  mutate(
    posterior_prob = plogis(estimate),  # convert log-odds to probability
    lower_prob = plogis(lower),
    upper_prob = plogis(upper)
  )

ggplot(region_compare, aes(x = reorder(regionid, raw_rate))) +
  geom_point(aes(y = raw_rate), color = "blue", size = 2, alpha = 0.6) +
  geom_point(aes(y = posterior_prob), color = "red", size = 2, alpha = 0.6) +
  geom_errorbar(aes(ymin = lower_prob, ymax = upper_prob), color = "red", width = 0.2, alpha = 0.5) +
  coord_flip() +
  labs(
    title = "Shrinkage: Raw vs Posterior Region-Level Late-Stage Probabilities",
    x = "Region ID",
    y = "Probability of Late-Stage Diagnosis",
    caption = "Blue = raw rate, Red = posterior mean ± 95% CI"
  ) +
  theme_minimal()
```

The plot visualizes the effect of Bayesian shrinkage on region-level estimates of late-stage diagnosis probabilities. Each region’s raw proportion (blue dots) is plotted alongside the corresponding posterior mean and 95% credible interval (red dots and error bars). Across all three regions, the raw rates of late-stage diagnosis vary slightly, but the posterior estimates are drawn toward the global average due to partial pooling. This is especially evident in regions with smaller sample sizes or greater uncertainty, where the posterior means are more conservative and the intervals wider. 

## Intra-Class Correlation

ICC (intra-class correlation) quantifies the proportion of total variance attributable to grouping structure. Here we compute ICC for both patients and regions.

```{r ICC}
posterior <- as_draws_df(brm_model2)
posterior <- posterior %>%
  mutate(
    var_patient = sd_patientid__Intercept^2,
    var_region  = sd_regionid__Intercept^2,
    var_resid   = (pi^2) / 3,

    ICC_patientid = var_patient / (var_patient + var_region + var_resid),
    ICC_regionid  = var_region  / (var_patient + var_region + var_resid)
  )
# Compute posterior summaries
icc_summary <- posterior %>%
  summarise(
    SD_patient = mean(sd_patientid__Intercept),
    SD_region = mean(sd_regionid__Intercept),
    
    ICC_patient_mean = mean(ICC_patientid),
    ICC_patient_low  = quantile(ICC_patientid, 0.025),
    ICC_patient_high = quantile(ICC_patientid, 0.975),
    
    ICC_region_mean = mean(ICC_regionid),
    ICC_region_low  = quantile(ICC_regionid, 0.025),
    ICC_region_high = quantile(ICC_regionid, 0.975)
  )

# Create simple summary table
icc_table <- tibble(
  Group = c("Patient", "Region"),
  SD = c(icc_summary$SD_patient, icc_summary$SD_region),
  ICC = c(icc_summary$ICC_patient_mean, icc_summary$ICC_region_mean),
  CI = c(
    sprintf("[%.3f, %.3f]", icc_summary$ICC_patient_low, icc_summary$ICC_patient_high),
    sprintf("[%.3f, %.3f]", icc_summary$ICC_region_low, icc_summary$ICC_region_high)
  )
)

knitr::kable(icc_table, caption = "Posterior Intra-Class Correlation Estimates")
```

The Patient-Level ICC (0.943) indicates that approximately 94.3% of the total variance in outcomes is due to differences between patients, with a narrow 95% credible interval of [0.841, 0.978]. This suggests strong patient-specific heterogeneity, meaning individual-level characteristics explain most of the variability in diagnosis outcomes. In contrast, the region-level ICC is 1.5%, with a wider credible interval of [0.000, 0.112], suggesting that very little variance is explained by differences between regions. The lower bound of zero and the upper bound just above 11% indicate weak and uncertain regional effects, possibly due to regional homogeneity or limited sample size at the region level.

```{r ICC Density}
posterior %>%
  select(ICC_patientid, ICC_regionid) %>%
  pivot_longer(everything(), names_to = "Level", values_to = "ICC") %>%
  ggplot(aes(x = ICC, fill = Level)) +
  geom_density(alpha = 0.5) +
  labs(title = "Posterior ICC Distributions",
       x = "ICC", y = "Density") +
  theme_minimal()
```

The posterior ICC distribution plot vividly illustrates the stark contrast in variance explained at the patient and region levels. The red density curve, representing patient-level ICCs, is sharply concentrated near 1.0, indicating that for nearly all posterior samples, a very high proportion of outcome variability is attributed to individual patients. This reinforces strong within-patient clustering and heterogeneity in late-stage diagnosis risk. Conversely, the blue density curve for region-level ICCs is concentrated near 0, suggesting that region explains virtually none of the outcome variation, with most samples falling below 0.05. The non-overlapping and polarized nature of these distributions confirms that individual-level effects dominate, while regional variation is minimal and likely negligible in the context of this hierarchical model.

# Preparing Data for Clustering

We want to do BGMM, so we need to standardizee values after extracting. Since we are interested in patient clustering, we will use dfRE_P, the summary for patient level random effects.

```{r dfRE_P}
dfRE_P <- as.data.frame(re$patientid)
dfRE_P <- tibble::rownames_to_column(dfRE_P, var = "PatientID")
dfRE_P <- dfRE_P %>%
  mutate(shrinkage = Q97.5.Intercept - Q2.5.Intercept)
```

```{r Standardize and Save}
standardize_df <- function(df, id_col = NULL) {
  if (!is.null(id_col)) {
    ids <- df[[id_col]]
    num_data <- df %>% select(where(is.numeric))
    scaled_data <- as.data.frame(scale(num_data))
    scaled_data[[id_col]] <- ids
    return(scaled_data)
  } else {
    return(as.data.frame(scale(df %>% select(where(is.numeric)))))
  }
}

dfRE_P_std <- standardize_df(dfRE_P, id_col = "PatientID")
# write.csv(dfRE_P_std, "../data/clean/dfRE_P.csv", row.names = FALSE)
```
